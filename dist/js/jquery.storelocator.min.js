/*! jQuery Google Maps Store Locator - v1.4.9 - 2014-04-20
* http://www.bjornblog.com/web/jquery-store-locator-plugin
* Copyright (c) 2014 Bjorn Holine; Licensed MIT */

!function(a){a.fn.storeLocator=function(b){var c=a.extend({mapDiv:"map",listDiv:".bh-storelocator-loc-list",formContainerDiv:".bh-storelocator-form-container",formID:"user-location",inputID:"address",regionID:"region",zoomLevel:12,pinColor:"fe7569",pinTextColor:"000000",lengthUnit:"m",storeLimit:26,distanceAlert:60,dataType:"xml",dataLocation:"data/locations.xml",listColor1:"ffffff",listColor2:"eeeeee",originMarker:!1,originpinColor:"blue",bounceMarker:!0,slideMap:!0,modalWindow:!1,overlayDiv:".bh-storelocator-overlay",modalWindowDiv:".bh-storelocator-modal-window",modalContentDiv:".bh-storelocator-modal-content",modalCloseIconDiv:".bh-storelocator-modal-close-icon",defaultLoc:!1,defaultLat:"",defaultLng:"",autoGeocode:!1,maxDistance:!1,maxDistanceID:"maxdistance",fullMapStart:!1,noForm:!1,loading:!1,loadingDiv:"bh-storelocator-loading",featuredLocations:!1,infowindowTemplatePath:"templates/infowindow-description.html",listTemplatePath:"templates/location-list-description.html",KMLinfowindowTemplatePath:"templates/kml-infowindow-description.html",KMLlistTemplatePath:"templates/kml-location-list-description.html",listTemplateID:null,infowindowTemplateID:null,callbackBeforeSend:null,callbackComplete:null,callbackSuccess:null,callbackModalOpen:null,callbackModalClose:null,jsonpCallback:null,geocodeErrorAlert:"Geocode was not successful for the following reason: ",addressErrorAlert:"Unable to find address",autoGeocodeErrorAlert:"Automatic location detection failed. Please fill in your address or zip code.",distanceErrorAlert:"Unfortunately, our closest location is more than ",mileLang:"mile",milesLang:"miles",kilometerLang:"kilometer",kilometersLang:"kilometers"},b);return this.each(function(){function b(){function b(){s=[],t=[],u=[],v=[],a(document).off("click."+w,c.listDiv+" li")}function g(){if(c.defaultLoc===!0){var a=new i,b=new google.maps.LatLng(c.defaultLat,c.defaultLng);a.geocode({latLng:b},function(a){if(null!==a){var b=a.address;o(c.defaultLat,c.defaultLng,b)}else alert(c.addressErrorAlert)})}c.fullMapStart===!0&&o(),c.autoGeocode===!0&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(k,l)}function h(){geocoder=new google.maps.Geocoder,this.geocode=function(a,b){geocoder.geocode(a,function(a,d){if(d===google.maps.GeocoderStatus.OK){var e={};e.latitude=a[0].geometry.location.lat(),e.longitude=a[0].geometry.location.lng(),b(e)}else alert(c.geocodeErrorAlert+d),b(null)})}}function i(){geocoder=new google.maps.Geocoder,this.geocode=function(a,b){geocoder.geocode(a,function(a,d){if(d===google.maps.GeocoderStatus.OK){if(a[0]){var e={};e.address=a[0].formatted_address,b(e)}}else alert(c.geocodeErrorAlert+d),b(null)})}}function j(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}function k(a){var b=new i,d=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);b.geocode({latLng:d},function(b){if(null!==b){var d=b.address;o(a.coords.latitude,a.coords.longitude,d)}else alert(c.addressErrorAlert)})}function l(){alert(c.autoGeocodeErrorAlert)}function m(a,b){var c=new google.maps.DistanceMatrixService,d={origins:a,destinations:b,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL,avoidHighways:!1,avoidTolls:!1};c.getDistanceMatrix(d,function(a,b){return console.log(b),b===google.maps.DistanceMatrixStatus.OK?a:void 0})}function n(b){var d=a("#"+c.inputID).val(),e=a("#"+c.regionID).val();if(""===d)g();else{var f=new h,i=d;f.geocode({address:i,region:e},function(a){null!==a?(p=a.latitude,q=a.longitude,o(p,q,d,b)):alert(c.addressErrorAlert)})}}function o(g,h,i,k){a(function(){google.maps.visualRefresh=!0;var l,n=new google.maps.LatLng(g,h);l="kml"===c.dataType?"xml":c.dataType,a.ajax({type:"GET",url:c.dataLocation+("jsonp"===c.dataType?(c.dataLocation.match(/\?/)?"&":"?")+"callback=?":""),dataType:l,jsonpCallback:"jsonp"===c.dataType?c.jsonpCallback:null,beforeSend:function(){c.callbackBeforeSend&&c.callbackBeforeSend.call(this),c.loading===!0&&a("."+c.formContainerDiv).append('<div class="'+c.loadingDiv+'"></div>')},complete:function(b,d,e){c.callbackComplete&&c.callbackComplete.call(this,b,d,e),c.loading===!0&&a("."+c.loadingDiv).remove()},success:function(l,o,p){function q(a){a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0})}c.callbackSuccess&&c.callbackSuccess.call(this,l,o,p);var y,z=0,A=[],B=[];if(c.fullMapStart===!0&&a(c.mapDiv).hasClass("mapOpen")===!1?y=!0:b(),a(c.mapDiv).addClass("mapOpen"),"json"===c.dataType||"jsonp"===c.dataType?a.each(l,function(){var a,b,d={};for(a in this)b=this[a],"web"===a&&b&&(b=b.replace("http://","")),d[a]=b;if(d.distance||(d.distance=x.CalcDistance(g,h,d.lat,d.lng,x.EarthRadius)),c.maxDistance===!0&&y!==!0&&k){if(!(d.distance<k))return;s[z]=d}else s[z]=d;z++}):"kml"===c.dataType?a(l).find("Placemark").each(function(){var b={name:a(this).find("name").text(),lat:a(this).find("coordinates").text().split(",")[1],lng:a(this).find("coordinates").text().split(",")[0],description:a(this).find("description").text()};if(b.distance=x.CalcDistance(g,h,b.lat,b.lng,x.EarthRadius),c.maxDistance===!0&&y!==!0&&k){if(!(b.distance<k))return;s[z]=b}else s[z]=b;z++}):a(l).find("marker").each(function(){var b={name:a(this).attr("name"),lat:a(this).attr("lat"),lng:a(this).attr("lng"),address:a(this).attr("address"),address2:a(this).attr("address2"),city:a(this).attr("city"),state:a(this).attr("state"),postal:a(this).attr("postal"),country:a(this).attr("country"),phone:a(this).attr("phone"),email:a(this).attr("email"),web:a(this).attr("web"),hours1:a(this).attr("hours1"),hours2:a(this).attr("hours2"),hours3:a(this).attr("hours3"),category:a(this).attr("category"),featured:a(this).attr("featured")};if(b.web&&(b.web=b.web.replace("http://","")),!b.distance){b.distance=x.CalcDistance(g,h,b.lat,b.lng,x.EarthRadius);var d=new google.maps.LatLng(b.lat,b.lng);A[z]=n,B[z]=d}if(c.maxDistance===!0&&y!==!0&&k){if(!(b.distance<k))return;s[z]=b}else s[z]=b;z++}),s.length<26){m(A,B)}q(s),c.featuredLocations===!0&&(t=a.grep(s,function(a){return"true"===a.featured}),u=a.grep(s,function(a){return"true"!==a.featured}),s=[],s=t.concat(u));var C="km"===c.lengthUnit?c.kilometersLang:c.milesLang;if(c.maxDistance===!0&&y!==!0&&k){if(void 0===s[0]||s[0].distance>k)return void alert(c.distanceErrorAlert+k+" "+C)}else-1!==c.distanceAlert&&s[0].distance>c.distanceAlert&&alert(c.distanceErrorAlert+c.distanceAlert+" "+C);a(function(){function b(a){for(o in s[a])p=s[a][o],"distance"===o&&(p=j(p,2)),q[o]=p}function g(d){b(d.get("id"));var e;e=q.distance<=1?"km"===c.lengthUnit?c.kilometerLang:c.mileLang:"km"===c.lengthUnit?c.kilometersLang:c.milesLang;var f=d.get("id");if(-1===c.storeLimit||c.storeLimit>26)var g=f+1;else var g=String.fromCharCode("A".charCodeAt(0)+f);var h={location:[a.extend(q,{markerid:f,marker:g,length:e,origin:i})]};return h}function h(){c.callbackModalOpen&&c.callbackModalOpen.call(this),a(c.overlayDiv).hide()}function k(b){var e=g(b),f=d(e);a(c.listDiv+" ul").append(f)}function l(a,b,d,e){var f=new google.maps.MarkerImage("https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+e+"|"+c.pinColor+"|"+c.pinTextColor,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));if(-1===c.storeLimit||c.storeLimit>26)var g=new google.maps.Marker({position:a,map:x,draggable:!1});else var g=new google.maps.Marker({position:a,map:x,icon:f,draggable:!1});return g}function m(b,d){var f=g(b),h=e(f);"left"===d?(z.setContent(h),z.open(b.get("map"),b)):google.maps.event.addListener(b,"click",function(){z.setContent(h),z.open(b.get("map"),b),a(c.listDiv+" li").removeClass("list-focus"),markerId=b.get("id"),a(c.listDiv+" li[data-markerid="+markerId+"]").addClass("list-focus");var d=a(c.listDiv),e=a(c.listDiv+" li[data-markerid="+markerId+"]");a(c.listDiv).animate({scrollTop:e.offset().top-d.offset().top+d.scrollTop()})})}var o,p,q={};if(c.slideMap===!0&&f.slideDown(),c.modalWindow===!0&&(c.callbackModalOpen&&c.callbackModalOpen.call(this),a("."+c.overlayDiv).fadeIn(),a(document).on("click."+w,c.modalCloseIconDiv+", "+c.overlayDiv,function(){h()}),a(document).on("click."+w,c.modalWindowDiv,function(a){a.stopPropagation()}),a(document).on("keyup."+w,function(a){27===a.keyCode&&h()})),c.fullMapStart===!0&&y===!0||0===c.zoomLevel)var t={mapTypeId:google.maps.MapTypeId.ROADMAP},u=new google.maps.LatLngBounds;else var t={zoom:c.zoomLevel,center:n,mapTypeId:google.maps.MapTypeId.ROADMAP};var x=new google.maps.Map(document.getElementById(c.mapDiv.replace("#")),t);f.data(c.mapDiv.replace("#"),x);var z=new google.maps.InfoWindow;if(r=-1===c.storeLimit||s.length-1<c.storeLimit-1?s.length-1:c.storeLimit-1,c.originMarker===!0&&c.fullMapStart===!1)var A=new google.maps.Marker({position:n,map:x,icon:"https://maps.google.com/mapfiles/ms/icons/"+c.originpinColor+"-dot.png",draggable:!1});for(var B=0;r>=B;B++){var C=String.fromCharCode("A".charCodeAt(0)+B),D=new google.maps.LatLng(s[B].lat,s[B].lng);A=l(D,s[B].name,s[B].address,C),A.set("id",B),v[B]=A,(c.fullMapStart===!0&&y===!0||0===c.zoomLevel)&&u.extend(D),m(A)}(c.fullMapStart===!0&&y===!0||0===c.zoomLevel)&&x.fitBounds(u),a(c.listDiv+" ul").empty(),a(v).each(function(a){var b=(String.fromCharCode("A".charCodeAt(0)+a),v[a]);k(b)}),a(document).on("click."+w,c.listDiv+" li",function(){var b=a(this).data("markerid"),d=v[b];a(c.listDiv+" li").removeClass("list-focus"),a(c.listDiv+" li[data-markerid="+b+"]").addClass("list-focus"),x.panTo(d.getPosition());var e="left";c.bounceMarker===!0?(d.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){d.setAnimation(null),m(d,e)},700)):m(d,e)}),a(c.listDiv+" ul li:even").css("background","#"+c.listColor1),a(c.listDiv+" ul li:odd").css("background","#"+c.listColor2)})}})})}var p,q,r,s=[],t=[],u=[],v=[],w="storeLocator";c.modalWindow===!0&&(f.wrap('<div class="'+c.overlayDiv+'"><div class="'+c.modalWindowDiv+'"><div class="'+c.modalContentDiv+'">'),a("."+c.modalWindowDiv).prepend('<div class="'+c.modalCloseIconDiv+'"></div>'),a("."+c.overlayDiv).hide()),c.slideMap===!0&&f.hide();var x={};x.EarthRadius="km"===c.lengthUnit?6367:3956,x.ToRadian=function(a){return a*(Math.PI/180)},x.DiffRadian=function(a,b){return x.ToRadian(b)-x.ToRadian(a)},x.CalcDistance=function(a,b,c,d,e){return 2*e*Math.asin(Math.min(1,Math.sqrt(Math.pow(Math.sin(x.DiffRadian(a,c)/2),2)+Math.cos(x.ToRadian(a))*Math.cos(x.ToRadian(c))*Math.pow(Math.sin(x.DiffRadian(b,d)/2),2))))},g(),a(function(){function b(b){if(b.preventDefault(),c.maxDistance===!0){var d=a("#"+c.maxDistanceID).val();n(d)}else n()}c.noForm===!0?(a(document).on("click."+w,"."+c.formContainerDiv+" button",function(a){b(a)}),a(document).on("keyup."+w,function(d){13===d.keyCode&&a("#"+c.inputID).is(":focus")&&b(d)})):a(document).on("submit."+w,"#"+c.formID,function(a){b(a)})})}var d,e,f=a(this);"kml"===c.dataType&&null===c.listTemplateID&&null===c.infowindowTemplateID?a.when(a.get(c.KMLinfowindowTemplatePath,function(a){var b=a;e=Handlebars.compile(b)}),a.get(c.KMLlistTemplatePath,function(a){var b=a;d=Handlebars.compile(b)})).then(function(){b()},function(){}):null!==c.listTemplateID&&null!==c.infowindowTemplateID?(e=Handlebars.compile(a(c.infowindowTemplateID).html()),d=Handlebars.compile(a(c.listTemplateID).html()),b()):a.when(a.get(c.infowindowTemplatePath,function(a){var b=a;e=Handlebars.compile(b)}),a.get(c.listTemplatePath,function(a){var b=a;d=Handlebars.compile(b)})).then(function(){b()},function(){})})}}(jQuery);