/*! jQuery Google Maps Store Locator - v1.4.9 - 2014-07-11
* http://www.bjornblog.com/web/jquery-store-locator-plugin
* Copyright (c) 2014 Bjorn Holine; Licensed MIT */

!function(a){"use strict";a.fn.storeLocator=function(b){var c=a.extend({mapDiv:"map",listDiv:".bh-storelocator-loc-list",formContainerDiv:".bh-storelocator-form-container",formID:"user-location",inputID:"address",regionID:"region",mapSettings:{zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP},pinColor:"fe7569",pinTextColor:"000000",lengthUnit:"m",storeLimit:26,distanceAlert:60,dataType:"xml",dataLocation:"data/locations.xml",xmlElement:"marker",listColor1:"ffffff",listColor2:"eeeeee",originMarker:!1,originpinColor:"blue",bounceMarker:!0,slideMap:!0,modalWindow:!1,overlayDiv:"bh-storelocator-overlay",modalWindowDiv:"bh-storelocator-modal-window",modalContentDiv:"bh-storelocator-modal-content",modalCloseIconDiv:"bh-storelocator-modal-close-icon",defaultLoc:!1,defaultLat:"",defaultLng:"",autoGeocode:!1,maxDistance:!1,maxDistanceID:"maxdistance",fullMapStart:!1,noForm:!1,loading:!1,loadingDiv:"bh-storelocator-loading",featuredLocations:!1,pagination:!1,locationsPerPage:10,infowindowTemplatePath:"templates/infowindow-description.html",listTemplatePath:"templates/location-list-description.html",KMLinfowindowTemplatePath:"templates/kml-infowindow-description.html",KMLlistTemplatePath:"templates/kml-location-list-description.html",listTemplateID:null,infowindowTemplateID:null,taxonomyFilters:null,callbackBeforeSend:null,callbackComplete:null,callbackSuccess:null,callbackModalOpen:null,callbackModalClose:null,jsonpCallback:null,geocodeErrorAlert:"Geocode was not successful for the following reason: ",addressErrorAlert:"Unable to find address",autoGeocodeErrorAlert:"Automatic location detection failed. Please fill in your address or zip code.",distanceErrorAlert:"Unfortunately, our closest location is more than ",mileLang:"mile",milesLang:"miles",kilometerLang:"kilometer",kilometersLang:"kilometers",noResultsTitle:"No results",noResultsDesc:"No locations were found with the given criteria. Please modify your selections or input."},b);return this.each(function(){function d(){M=[],N=[],O=[],P=[],a(document).off("click."+T,c.listDiv+" li")}function e(){var b=a.Deferred();return a.ajax({type:"GET",url:c.dataLocation+("jsonp"===c.dataType?(c.dataLocation.match(/\?/)?"&":"?")+"callback=?":""),dataType:E,jsonpCallback:"jsonp"===c.dataType?c.jsonpCallback:null}).done(function(a){b.resolve(a)}).fail(b.reject),b.promise()}function f(){var a=0;if(!m(Q))for(var b in Q)a+=Q[b].length;return a}function g(){a.each(c.taxonomyFilters,function(b,c){a(c+" input[type=checkbox]").each(function(){if(a(this).prop("checked")){var c=a(this).attr("id");-1===Q[b].indexOf(c)&&Q[b].push(c)}}),a(c+" select").each(function(){var c=a(this).attr("id");-1===Q[b].indexOf(c)&&Q[b].push(c)})})}function h(a){for(var b in c.taxonomyFilters)if(c.taxonomyFilters.hasOwnProperty(b))for(var d=0;d<c.taxonomyFilters[b].length;d++)if(c.taxonomyFilters[b]===a)return b}function i(){if(c.defaultLoc===!0){var a=new k,b=new google.maps.LatLng(c.defaultLat,c.defaultLng);a.geocode({latLng:b},function(a){if(null!==a){var b=a.address;A(F,c.defaultLat,c.defaultLng,b)}else alert(c.addressErrorAlert)})}c.fullMapStart===!0&&A(F),c.autoGeocode===!0&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(w,x)}function j(){var a=new google.maps.Geocoder;this.geocode=function(b,d){a.geocode(b,function(a,b){if(b===google.maps.GeocoderStatus.OK){var e={};e.latitude=a[0].geometry.location.lat(),e.longitude=a[0].geometry.location.lng(),d(e)}else alert(c.geocodeErrorAlert+b),d(null)})}}function k(){var a=new google.maps.Geocoder;this.geocode=function(b,d){a.geocode(b,function(a,b){if(b===google.maps.GeocoderStatus.OK){if(a[0]){var e={};e.address=a[0].formatted_address,d(e)}}else alert(c.geocodeErrorAlert+b),d(null)})}}function l(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}function m(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function n(){c.callbackModalOpen&&c.callbackModalOpen.call(this),a("."+c.overlayDiv).hide()}function o(a){var b,c;for(b in M[a])c=M[a][b],"distance"===b&&(c=l(c,2)),R[b]=c}function p(a){a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0})}function q(a,b){var c=!0;for(var d in b)new RegExp(b[d].join("")).test(a[d])||(c=!1);return c?!0:void 0}function r(b){if(0===a(".bh-storelocator-pagination-container ol").length){void 0===b&&(b=0);for(var d="",e=0;e<M.length/c.locationsPerPage;e++){var f=e+1;d+=e===b?'<li data-page="'+e+'" class="bh-storelocator-current">'+f+"</li>":'<li data-page="'+e+'">'+f+"</li>"}a(".bh-storelocator-pagination-container").append('<ol class="bh-storelocator-pagination">'+d+"</ol>")}}function s(a,b,d,e,f){var g=new google.maps.MarkerImage("https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+e+"|"+c.pinColor+"|"+c.pinTextColor,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));if(-1===c.storeLimit||c.storeLimit>26)var h=new google.maps.Marker({position:a,map:f,draggable:!1});else var h=new google.maps.Marker({position:a,map:f,icon:g,draggable:!1});return h}function t(b,d,e){var f="";o(b.get("id"));var g;g=R.distance<=1?"km"===c.lengthUnit?c.kilometerLang:c.mileLang:"km"===c.lengthUnit?c.kilometersLang:c.milesLang;var h=b.get("id");f=-1===c.storeLimit||c.storeLimit>26?h+1:String.fromCharCode(e>0?"A".charCodeAt(0)+(d+h):"A".charCodeAt(0)+h);var i={location:[a.extend(R,{markerid:h,marker:f,length:g,origin:H})]};return i}function u(b,d,e){var f=t(b,d,e),g=C(f);a(c.listDiv+" ul").append(g)}function v(b,d,e,f,g){var h=t(b,f,g),i=D(h);"left"===d?(e.setContent(i),e.open(b.get("map"),b)):google.maps.event.addListener(b,"click",function(){e.setContent(i),e.open(b.get("map"),b),a(c.listDiv+" li").removeClass("list-focus");var d=b.get("id");a(c.listDiv+" li[data-markerid="+d+"]").addClass("list-focus");var f=a(c.listDiv),g=a(c.listDiv+" li[data-markerid="+d+"]");a(c.listDiv).animate({scrollTop:g.offset().top-f.offset().top+f.scrollTop()})})}function w(a){var b=new k,d=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);b.geocode({latLng:d},function(b){if(null!==b){var d=b.address;A(F,a.coords.latitude,a.coords.longitude,d)}else alert(c.addressErrorAlert)})}function x(){alert(c.autoGeocodeErrorAlert)}function y(b){var e;c.maxDistance===!0&&(e=a("#"+c.maxDistanceID).val()),d(),A(F,I,J,H,e,b)}function z(b){H=a("#"+c.inputID).val();var d=a("#"+c.regionID).val();if(""===H)i();else{var e=new j,f=H;e.geocode({address:f,region:d},function(a){null!==a?(I=a.latitude,J=a.longitude,A(F,I,J,H,b)):alert(c.addressErrorAlert)})}}function A(e,f,g,h,i,j){a(function(){google.maps.visualRefresh=!0;var h=new google.maps.LatLng(f,g);void 0===j&&(j=0),U.then(function(){c.callbackSuccess&&c.callbackSuccess.call(this,e,xhr,b);var k,l=0,o=[],t=[];if(c.fullMapStart===!0&&a("#"+c.mapDiv).hasClass("bh-storelocator-map-open")===!1?k=!0:d(),a("#"+c.mapDiv).addClass("bh-storelocator-map-open"),"json"===c.dataType||"jsonp"===c.dataType?a.each(e,function(){var a,b,d={};for(a in this)b=this[a],"web"===a&&b&&(b=b.replace("http://","")),d[a]=b;if(d.distance||(d.distance=S.CalcDistance(f,g,d.lat,d.lng,S.EarthRadius)),c.maxDistance===!0&&k!==!0&&i){if(!(d.distance<i))return;M[l]=d}else M[l]=d;l++}):"kml"===c.dataType?a(e).find("Placemark").each(function(){var b={name:a(this).find("name").text(),lat:a(this).find("coordinates").text().split(",")[1],lng:a(this).find("coordinates").text().split(",")[0],description:a(this).find("description").text()};if(b.distance=S.CalcDistance(f,g,b.lat,b.lng,S.EarthRadius),c.maxDistance===!0&&k!==!0&&i){if(!(b.distance<i))return;M[l]=b}else M[l]=b;l++}):a(e).find(c.xmlElement).each(function(){var b={};if(a.each(this.attributes,function(a,c){b[c.name]=c.value}),b.web&&(b.web=b.web.replace("http://","")),!b.distance){b.distance=S.CalcDistance(f,g,b.lat,b.lng,S.EarthRadius);var d=new google.maps.LatLng(b.lat,b.lng);o[l]=h,t[l]=d}if(c.maxDistance===!0&&k!==!0&&i){if(!(b.distance<i))return;M[l]=b}else M[l]=b;l++}),null!==c.taxonomyFilters){var w={};if(a.each(Q,function(a,b){if(b.length>0)for(var c=0;c<b.length;c++)w[a]||(w[a]=[]),w[a][c]="(?=.*\\b"+b[c].replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")+"\\b)"}),!m(w)){var x=a.grep(M,function(a){return q(a,w)});M=x}}m(M)&&(M[0]={address:c.noResultsDesc,address2:"",lat:"",lng:"",name:c.noResultsTitle}),p(M),c.featuredLocations===!0&&(N=a.grep(M,function(a){return"true"===a.featured}),O=a.grep(M,function(a){return"true"!==a.featured}),M=[],M=N.concat(O));var z="km"===c.lengthUnit?c.kilometersLang:c.milesLang;if(c.maxDistance===!0&&k!==!0&&i){if(void 0===M[0]||M[0].distance>i)return void alert(c.distanceErrorAlert+i+" "+z)}else-1!==c.distanceAlert&&M[0].distance>c.distanceAlert&&alert(c.distanceErrorAlert+c.distanceAlert+" "+z);c.pagination===!0&&r(),a(function(){var b;if(c.slideMap===!0&&L.slideDown(),c.modalWindow===!0&&(c.callbackModalOpen&&c.callbackModalOpen.call(this),a("."+c.overlayDiv).fadeIn(),a(document).on("click."+T,"."+c.modalCloseIconDiv+", ."+c.overlayDiv,function(){n()}),a(document).on("click."+T,c.modalWindowDiv,function(a){a.stopPropagation()}),a(document).on("keyup."+T,function(a){27===a.keyCode&&n()})),K=-1===c.storeLimit||M.length<c.storeLimit?M.length:c.storeLimit,c.pagination===!0?(b=c.locationsPerPage,m=j*c.locationsPerPage,M=M.slice(m,m+b),K=M.length):(b=K,m=0),c.fullMapStart===!0&&k===!0||0===c.mapSettings.zoom)var d=c.mapSettings,e=new google.maps.LatLngBounds;else if(c.pagination===!0){var f=new google.maps.LatLng(M[0].lat,M[0].lng);if(0===j){c.mapSettings.center=h;var d=c.mapSettings}else{c.mapSettings.center=f;var d=c.mapSettings}}else{c.mapSettings.center=h;var d=c.mapSettings}var g=new google.maps.Map(document.getElementById(c.mapDiv.replace("#")),d);L.data(c.mapDiv.replace("#"),g);var i=new google.maps.InfoWindow;if(c.originMarker===!0&&c.fullMapStart===!1)var l=new google.maps.Marker({position:h,map:g,icon:"https://maps.google.com/mapfiles/ms/icons/"+c.originpinColor+"-dot.png",draggable:!1});var m;a(document).on("click."+T,".bh-storelocator-pagination li",function(){a(".bh-storelocator-pagination li").attr("class",""),a(this).addClass("bh-storelocator-current"),y(a(this).attr("data-page"))});for(var o=0;b-1>=o;o++){var p="";p=String.fromCharCode(j>0?"A".charCodeAt(0)+(m+o):"A".charCodeAt(0)+o);var q=new google.maps.LatLng(M[o].lat,M[o].lng);l=s(q,M[o].name,M[o].address,p,g),l.set("id",o),P[o]=l,(c.fullMapStart===!0&&k===!0||0===c.mapSettings.zoom)&&e.extend(q),v(l,null,i,m,j)}(c.fullMapStart===!0&&k===!0||0===c.mapSettings.zoom)&&g.fitBounds(e),a(c.listDiv+" ul").empty(),a(P).each(function(a){var b=(String.fromCharCode("A".charCodeAt(0)+a),P[a]);u(b,m,j)}),a(document).on("click."+T,c.listDiv+" li",function(){var b=a(this).data("markerid"),d=P[b];a(c.listDiv+" li").removeClass("list-focus"),a(c.listDiv+" li[data-markerid="+b+"]").addClass("list-focus"),g.panTo(d.getPosition());var e="left";c.bounceMarker===!0?(d.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){d.setAnimation(null),v(d,e,i,m,j)},700)):v(d,e,i,m,j)}),a(c.listDiv+" ul li:even").css("background","#"+c.listColor1),a(c.listDiv+" ul li:odd").css("background","#"+c.listColor2)})})})}function B(){null!==c.taxonomyFilters&&(a.each(c.taxonomyFilters,function(a){Q[a]=[]}),a(".bh-storelocator-filters-container").on("change."+T,"input, select",function(b){b.stopPropagation();var e,i,j;if(a(this).is('input[type="checkbox"]')){if(g(),e=a(this).val(),i=a(this).closest(".bh-storelocator-filters").attr("id"),j=h(i))if(a(this).prop("checked"))Q[j].push(e),a("#"+c.mapDiv).hasClass("bh-storelocator-map-open")===!0&&(d(),I&&J?(c.mapSettings.zoom=0,z()):A(F));else{var k=Q[j].indexOf(e);k>-1&&(Q[j].splice(k,1),a("#"+c.mapDiv).hasClass("bh-storelocator-map-open")===!0&&(d(),I&&J?(c.mapSettings.zoom=0===f()?G:0,z()):A(F)))}}else(a(this).is("select")||a(this).is('input[type="radio"]'))&&(g(),e=a(this).val(),i=a(this).closest(".bh-storelocator-filters").attr("id"),j=h(i),e?j&&(Q[j]=[e],a("#"+c.mapDiv).hasClass("bh-storelocator-map-open")===!0&&(d(),I&&J?(c.mapSettings.zoom=0,z()):A(F))):(j&&(Q[j]=[]),d(),I&&J?(c.mapSettings.zoom=G,z()):A(F)))})),c.modalWindow===!0&&(L.wrap('<div class="'+c.overlayDiv+'"><div class="'+c.modalWindowDiv+'"><div class="'+c.modalContentDiv+'">'),a("."+c.modalWindowDiv).prepend('<div class="'+c.modalCloseIconDiv+'"></div>'),a("."+c.overlayDiv).hide()),c.slideMap===!0&&L.hide(),i(),a(function(){function b(b){if(b.preventDefault(),c.maxDistance===!0){var d=a("#"+c.maxDistanceID).val();z(d)}else z()}c.noForm===!0?(a(document).on("click."+T,"."+c.formContainerDiv+" button",function(a){b(a)}),a(document).on("keyup."+T,function(d){13===d.keyCode&&a("#"+c.inputID).is(":focus")&&b(d)})):a(document).on("submit."+T,"#"+c.formID,function(a){b(a)})})}var C,D,E,F,G,H,I,J,K,L=a(this),M=[],N=[],O=[],P=[],Q={},R={},S={},T="storeLocator";S.EarthRadius="km"===c.lengthUnit?6367:3956,S.ToRadian=function(a){return a*(Math.PI/180)},S.DiffRadian=function(a,b){return S.ToRadian(b)-S.ToRadian(a)},S.CalcDistance=function(a,b,c,d,e){return 2*e*Math.asin(Math.min(1,Math.sqrt(Math.pow(Math.sin(S.DiffRadian(a,c)/2),2)+Math.cos(S.ToRadian(a))*Math.cos(S.ToRadian(c))*Math.pow(Math.sin(S.DiffRadian(b,d)/2),2))))},E="kml"===c.dataType?"xml":c.dataType;var U=e();U.done(function(a){F=a}),G=c.mapSettings.zoom,"kml"===c.dataType&&null===c.listTemplateID&&null===c.infowindowTemplateID?a.when(a.get(c.KMLinfowindowTemplatePath,function(a){var b=a;D=Handlebars.compile(b)}),a.get(c.KMLlistTemplatePath,function(a){var b=a;C=Handlebars.compile(b)})).then(function(){B()},function(){}):null!==c.listTemplateID&&null!==c.infowindowTemplateID?(D=Handlebars.compile(a(c.infowindowTemplateID).html()),C=Handlebars.compile(a(c.listTemplateID).html()),B()):a.when(a.get(c.infowindowTemplatePath,function(a){var b=a;D=Handlebars.compile(b)}),a.get(c.listTemplatePath,function(a){var b=a;C=Handlebars.compile(b)})).then(function(){B()},function(){})})}}(jQuery);